name: 'Push: branch "bot/release/*"'
run-name: "${{ contains(github.ref_name, '-') && format('Development release: {0}', github.ref_name) || format('Production release: {0}', github.ref_name) }}"

on:
  push:
    branches:
      - bot/release/*
  workflow_dispatch:
    inputs:
      dry-run:
        default: true # TODO: Turn this off.
        description: Dry run
        required: true
        type: boolean
      skip-secure-feed:
        default: true # TODO: Turn this off.
        description: Skip secure feed (only for development)
        required: true
        type: boolean

concurrency: on-push-branch-release

defaults:
  run:
    shell: bash

env:
  node-version: lts/Iron # Node.js 20
  skip-secure-feed: true

jobs:
  prepare:
    name: Prepare
    outputs:
      matrix: ${{ steps.read-matrix.outputs.matrix }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Print matrix.json
        run: jq -r '.' ./matrix.json
      - id: read-matrix
        name: Output matrix.json
        run: echo matrix=$(jq -cr '.' ./matrix.json) | tee --append $GITHUB_OUTPUT

  build:
    name: Build
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Node.js ${{ env.node-version }}
        uses: actions/setup-node@v3
        with:
          cache: npm
          node-version: ${{ env.node-version }}
      - if: '!env.skip-secure-feed'
        name: Set up secure feed
        run: npx https://aka.ms/EnableSecureFeed
      - run: npm clean-install --ignore-scripts --strict-peer-deps # Prevent malicious scripts from running.
      - name: Run whitelisted install scripts
        run: npm run postinstall --if-present --workspaces=true
      - name: Build
        run: npm run build --if-present --workspaces=true
      - name: Pack
        run: |
          mkdir -p .tmp/tarball/

          for entry in $(cat ./matrix.json | jq -cr '.[]')
          do
            name=$(echo $entry | jq -r '.name')
            path=$(echo $entry | jq -r '.path')
            expected_tarball=$(echo $entry | jq -r '.tarball')

            echo ::group::$path

            npm pack --json --pack-destination=.tmp/tarball/ --workspace=$name > .tmp/pack-result.json

            # Prints "npm pack" result.
            cat .tmp/pack-result.json | jq 'map(del(.files))'

            # Just in case if the tarball named differently than our matrix.json, rename it.
            actual_tarball=$(cat .tmp/pack-result.json | jq -r '.[0].filename')
            if [[ $actual_tarball != $expected_tarball ]]
            then
              echo ::warning::Expected tarball filename "$expected_tarball" is different than actual filename "$actual_tarball".
              mv .tmp/tarball/$actual_tarball .tmp/tarball/$expected_tarball
            fi

            echo ::endgroup::
          done
      - name: Upload packages artifact
        uses: actions/upload-artifact@v3
        with:
          if-no-files-found: error
          name: packages
          path: .tmp/tarball/

  github-pages-artifact:
    name: 'Build: GitHub Pages'
    needs:
      - build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          sparse-checkout: matrix.json
      - name: Download packages artifact
        uses: actions/download-artifact@v3
        with:
          name: packages
      - name: Make directory
        run: mkdir ./_site/
      - id: pages-tarball
        name: Get tarball filename
        run: echo tarball=$(cat ./matrix.json | jq -r '.[] | select(.name == "pages") | .tarball') | tee --append $GITHUB_OUTPUT
      - name: 'Sanity check: tarball exists'
        run: '[[ -f ${{ steps.pages-tarball.outputs.tarball }} ]]'
      - name: Extract ${{ steps.pages-tarball.outputs.tarball }}
        run: tar --directory=./_site/ --extract --file=${{ steps.pages-tarball.outputs.tarball }} --strip-components=2 --verbose package/public
      - name: List directory
        run: ls -la ./_site/
      - name: 'Sanity check: must have index.html'
        run: '[[ -f ./_site/index.html ]]'
      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v2

  sanity-check:
    name: 'Sanity check: ${{ matrix.name }}'
    needs:
      - build
      - prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJSON(needs.prepare.outputs.matrix) }}
    steps:
      - name: Download packages artifact
        uses: actions/download-artifact@v3
        with:
          name: packages
      - name: 'Sanity check: "${{ matrix.tarball }}" must exists'
        run: '[[ -f ./${{ matrix.tarball }} ]]'
      - name: Print package.json
        run: tar --extract --file=${{ matrix.tarball }} --to-stdout package/package.json | jq
      - name: 'Sanity check: tarball "name" field must be "${{ matrix.name }}"'
        run: '[[ $(tar --extract --file=${{ matrix.tarball }} --to-stdout package/package.json | jq -r .name) == "${{ matrix.name }}" ]]'
      - name: 'Sanity check: tarball "version" field must be "${{ matrix.version }}"'
        run: '[[ $(tar --extract --file=${{ matrix.tarball }} --to-stdout package/package.json | jq -r .version) == "${{ matrix.version }}" ]]'
      - name: 'Sanity check: tarball "private" field must be "${{ matrix.private }}"'
        run: |
          [[ $(tar --extract --file=${{ matrix.tarball }} --to-stdout package/package.json | jq -r '.private // false') == "${{ matrix.private }}" ]]

  github-pages-deployment:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    outputs:
      url: ${{ steps.deployment.outputs.page_url }}
    name: 'GitHub Pages: deploy'
    needs:
      - github-pages-artifact
      - sanity-check
    permissions:
      id-token: write
      pages: write
    runs-on: ubuntu-latest
    steps:
      - if: '!inputs.dry-run'
        name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

  npm-publishing:
    environment:
      name: npm-publish
      # Example: https://npmjs.com/package/powerva-chat-adapter/v/0.0.0-0
      url: https://npmjs.com/package/${{ matrix.name }}/v/${{ matrix.version }}
    # Skip publishing to NPM on forks.
    # TODO: Remove this. We are commenting out for testing.
    # if: github.repository_owner == 'microsoft'
    name: 'NPM: publish ${{ matrix.name }}@${{ matrix.version }}'
    needs:
      - build
      - prepare
      - sanity-check
    permissions:
      packages: write
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJSON(needs.prepare.outputs.matrix) }}
    steps:
      - if: '!matrix.private'
        uses: actions/checkout@v3
      - if: '!matrix.private'
        name: Download packages
        uses: actions/download-artifact@v3
        with:
          name: packages
          path: .tmp/tarball/
      - if: '!matrix.private'
        name: Set up Node.js ${{ env.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.node-version }}
      - if: '!matrix.private'
        name: List package
        run: ls -l .tmp/tarball/${{ matrix.tarball }}
      - if: '!matrix.private'
        name: Print package.json
        run: tar --extract --file=.tmp/tarball/${{ matrix.tarball }} --to-stdout package/package.json
      - id: has-published
        if: '!matrix.private'
        name: Checks if ${{ matrix.name }}@${{ matrix.version }} is already published
        uses: ./.github/actions/check-if-package-has-published
        with:
          name: ${{ matrix.name }}
          version: ${{ matrix.version }}
      - env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        if: '!matrix.private && !steps.has-published.outputs.published && !inputs.dry-run'
        name: Publish ${{ matrix.name }}@${{ matrix.version }}
        # TODO: Remove "echo".
        run: echo npm publish --json .tmp/tarball/${{ matrix.tarball }} --provenance
